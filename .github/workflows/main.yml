# è¿™ä¸ª Action çš„åå­—ï¼Œä¼šæ˜¾ç¤ºåœ¨ "Actions" æ ‡ç­¾é¡µ
name: Sync Upstream Releases

on:
  # 1. å…è®¸ä½ ä» Actions æ ‡ç­¾é¡µæ‰‹åŠ¨è§¦å‘è¿™ä¸ªå·¥ä½œæµ
  workflow_dispatch:
  
  # 2. è®¾å®šä¸€ä¸ªå®šæ—¶å™¨ (ä½¿ç”¨ UTC æ—¶é—´)
  # è¿™é‡Œçš„ '0 8 * * *' è¡¨ç¤ºæ¯å¤©çš„ UTC æ—¶é—´ 8:00 è¿è¡Œä¸€æ¬¡
  # ä½ å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹ï¼Œæˆ–è€…åˆ é™¤è¿™ä¸¤è¡Œæ¥å–æ¶ˆè‡ªåŠ¨è¿è¡Œ
  schedule:
    - cron: '0 8 * * *'

jobs:
  sync-releases:
    # ä½¿ç”¨æœ€æ–°çš„ Ubuntu ç³»ç»Ÿä½œä¸ºè¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest
    
    # å¿…é¡»è®¾ç½®æƒé™ï¼Œå…è®¸ Action å†™å…¥ä½ ä»“åº“çš„ Releases
    permissions:
      contents: write
      
    steps:
      # è¿™æ˜¯ä¸€ä¸ªæ ‡å‡†æ­¥éª¤ï¼Œå‡ ä¹æ‰€æœ‰ Action éƒ½ä¼šç”¨
      - name: Checkout code
        uses: actions/checkout@v4

      # æ ¸å¿ƒæ­¥éª¤ï¼šè¿è¡Œä¸€ä¸ªè„šæœ¬æ¥åŒæ­¥ Release
      - name: Sync Releases from Upstream
        env:
          # GITHUB_TOKEN æ˜¯ GitHub è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œç”¨æ¥æˆæƒ Action æ“ä½œä½ çš„ä»“åº“
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
          # -----------------------------------------------------
          # !! å”¯ä¸€éœ€è¦ä½ ä¿®æ”¹çš„åœ°æ–¹ !!
          # æŠŠ 'original_user/original_repo' æ›¿æ¢æˆä½ è¦åŒæ­¥çš„ã€åŸå§‹ä»“åº“ã€‘
          #
          # ç¤ºä¾‹: 
          # UPSTREAM_REPO: "torvalds/linux"
          # UPSTREAM_REPO: "microsoft/vscode"
          # UPSTREAM_REPO: "coolsnowwolf/lede"
          # -----------------------------------------------------
          UPSTREAM_REPO: "supzza/clianpro"
          
          # è¿™ä¼šè‡ªåŠ¨è·å–ä½ ã€å½“å‰ã€‘ä»“åº“çš„åç§° (ä¾‹å¦‚: your_name/your_fork)
          MY_REPO: ${{ github.repository }}
        
        run: |
          # ç¡®ä¿å‡ºé”™æ—¶ç«‹å³åœæ­¢
          set -e 
          # æ‰“å°æ‰€æœ‰æ‰§è¡Œçš„å‘½ä»¤ï¼Œå¸®æˆ‘ä»¬æ‰¾åˆ°é”™è¯¯è¡Œ
          set -x 
  
          echo "å¼€å§‹åŒæ­¥ Releases..."
          echo "ä¸Šæ¸¸ (æº) ä»“åº“: $UPSTREAM_REPO"
          echo "ä¸‹æ¸¸ (ç›®æ ‡) ä»“åº“: $MY_REPO"
          
          # åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½•æ¥ä¸‹è½½é™„ä»¶
          mkdir -p ./release_assets
          
          # 1. è·å–ä¸Šæ¸¸å’Œå½“å‰ä»“åº“çš„ Release æ ‡ç­¾åˆ—è¡¨
          # å­˜ä¸ºæ–‡ä»¶ï¼Œæ–¹ä¾¿åç»­æ¯”è¾ƒ
          gh release list --repo $UPSTREAM_REPO --json tagName -q ".[].tagName" > upstream_tags.txt
          gh release list --repo $MY_REPO --json tagName -q ".[].tagName" > my_tags.txt

          # 2. æ‰¾å‡ºä¸Šæ¸¸æœ‰ï¼Œä½†æˆ‘æ²¡æœ‰çš„æ ‡ç­¾
          # ä½¿ç”¨ grep å‘½ä»¤æ¥æ‰¾å‡ºå·®é›†
          # -F (å›ºå®šå­—ç¬¦ä¸²), -x (æ•´è¡ŒåŒ¹é…), -v (åå‘), -f (ä»æ–‡ä»¶è¯»å–æ¨¡å¼)
          # -----------------------------------------------------
          # â†“â†“â†“ å”¯ä¸€çš„ä¿®å¤åœ¨è¿™é‡Œ â†“â†“â†“
          #
          # åŠ ä¸Š '|| true' 
          # è¿™å¯ä»¥é˜²æ­¢åœ¨ "æ‰¾ä¸åˆ°åŒ¹é…é¡¹" (grep è¿”å› 1) æ—¶å¯¼è‡´è„šæœ¬å¤±è´¥
          # -----------------------------------------------------
          MISSING_TAGS=$(grep -Fxvf my_tags.txt upstream_tags.txt || true)

          if [ -z "$MISSING_TAGS" ]; then
            echo "ğŸ‰ ä½ çš„ä»“åº“ ($MY_REPO) å·²ç»ä¸ä¸Šæ¸¸ ($UPSTREAM_REPO) çš„ Releases ä¿æŒåŒæ­¥ã€‚"
            exit 0
          fi

          echo "å‘ç°ä»¥ä¸‹ç¼ºå¤±çš„ Releases: $MISSING_TAGS"
          echo "--- å¼€å§‹åŒæ­¥ ---"

          # 3. å¾ªç¯å¤„ç†æ¯ä¸€ä¸ªç¼ºå¤±çš„æ ‡ç­¾
          for TAG in $MISSING_TAGS
          do
            echo "[SYNC] æ­£åœ¨å¤„ç† $TAG..."
            
            # 3.1 ä»ä¸Šæ¸¸ä¸‹è½½è¯¥ Tag çš„æ‰€æœ‰é™„ä»¶åˆ° release_assets ç›®å½•
            echo "  > æ­£åœ¨ä¸‹è½½é™„ä»¶..."
            # -p "*" è¡¨ç¤ºä¸‹è½½æ‰€æœ‰é™„ä»¶, -D æŒ‡å®šä¸‹è½½ç›®å½•
            gh release download $TAG --repo $UPSTREAM_REPO -p "*" -D ./release_assets/
            
            # 3.2 è·å–åŸ Release çš„æ ‡é¢˜å’Œç¬”è®°
            echo "  > æ­£åœ¨è·å–å…ƒæ•°æ® (æ ‡é¢˜å’Œæè¿°)..."
            TITLE=$(gh release view $TAG --repo $UPSTREAM_REPO --json name -q ".name")
            NOTES=$(gh release view $TAG --repo $UPSTREAM_REPO --json body -q ".body")
            IS_PRERELEASE=$(gh release view $TAG --repo $UPSTREAM_REPO --json isPrerelease -q ".isPrerelease")
            
            # å‡†å¤‡åˆ›å»ºå‘½ä»¤
            CREATE_CMD="gh release create $TAG ./release_assets/* \
                        --repo $MY_REPO \
                        --title \"$TITLE\" \
                        --notes-file <(echo \"$NOTES\")" # ä½¿ç”¨ --notes-file å®Œç¾å¤„ç†å¤šè¡Œå’Œç‰¹æ®Šå­—ç¬¦
            
            if [ "$IS_PRERELEASE" = "true" ]; then
              CREATE_CMD="$CREATE_CMD --prerelease"
              echo "  > æ ‡è®°ä¸º 'é¢„å‘å¸ƒ' (Prerelease)"
            fi

            # 3.3 åœ¨ä½ çš„ä»“åº“ä¸Šåˆ›å»º Release å¹¶ä¸Šä¼ æ‰€æœ‰é™„ä»¶
            echo "  > æ­£åœ¨åˆ›å»º Release å¹¶ä¸Šä¼ é™„ä»¶..."
            eval $CREATE_CMD
                
            # 3.4 æ¸…ç† release_assets ç›®å½•ï¼Œä¸ºä¸‹ä¸€ä¸ªå¾ªç¯åšå‡†å¤‡
            echo "  > æ­£åœ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
            rm ./release_assets/*
            
            echo "[SYNC] $TAG åŒæ­¥å®Œæ¯•ã€‚"
            echo "--------------------"
          done

          echo "--- æ‰€æœ‰ç¼ºå¤±çš„ Releases åŒæ­¥å®Œæˆ ---"
